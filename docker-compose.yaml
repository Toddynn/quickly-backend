services:
     pgsql:
          image: postgres:16-alpine
          ports:
               - '${DB_PORT:-5432}:5432'
          container_name: 'pgsql'
          restart: always
          environment:
               POSTGRES_DB: ${POSTGRES_DB:-quicklydb}
               POSTGRES_USER: ${POSTGRES_USER:-pguser}
               POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-pgpassword}
          healthcheck:
               test:
                    [
                         'CMD-SHELL',
                         'pg_isready -U ${POSTGRES_USER:-pguser} -d ${POSTGRES_DB:-quicklydb}',
                    ]
               interval: 5s
               timeout: 5s
               retries: 5
          volumes:
               - postgres_data:/var/lib/postgresql/data

     adminer:
          image: adminer:latest
          restart: always
          ports:
               - '8080:8080'
          depends_on:
               pgsql:
                    condition: service_healthy

     pgadmin:
          image: dpage/pgadmin4
          environment:
               PGADMIN_DEFAULT_EMAIL: 'admin@teste.com'
               PGADMIN_DEFAULT_PASSWORD: 'Admin123'
          ports:
               - '8085:80'
          restart: always
          depends_on:
               pgsql:
                    condition: service_healthy

     mailhog:
          image: mailhog/mailhog
          ports:
               - '${MAIL_PORT:-1025}:1025'
               - '${MAIL_PORT:-8025}:8025'
          restart: always

     app:
          container_name: 'quickly-backend'
          build:
               context: .
               dockerfile: Dockerfile
          command: 'pnpm run start:dev'
          ports:
               - '${APP_PORT:-3000}:3000'
          env_file:
               - .env
          volumes:
               - .:/app
               - /app/node_modules
               - /app/dist
          develop:
               watch:
                    - action: sync
                      path: .
                      target: /app
                      ignore:
                           - node_modules/
                           - dist/
                           - .git/

                    - action: rebuild
                      path: package.json
                    - action: rebuild
                      path: pnpm-lock.yaml
          depends_on:
               pgsql:
                    condition: service_healthy
          environment:
               DB_HOST: pgsql
               DB_PORT: ${DB_PORT:-5432}
               DB_USER: ${DB_USER:-pguser}
               DB_PASSWORD: ${DB_PASSWORD:-pgpassword}
               DB_DATABASE: ${DB_DATABASE:-quicklydb}
               DB_SCHEMA: ${DB_SCHEMA:-public}
               DB_SYNC: ${DB_SYNC:-true}
               APP_PORT: ${APP_PORT:-3000}

volumes:
     postgres_data:

networks:
     default:
          name: quickly-network
          driver: bridge
